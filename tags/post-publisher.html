<post-publisher>
  <!--
  Copyright 2015-2016 icasdri

  This file is part of PostMaker.

  PostMaker is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  PostMaker is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with PostMaker.  If not, see <http://www.gnu.org/licenses/>.
  -->
  <div class="mui-container">
    <h2>Publishing《{ Publishing.post.title }》...</h2>
    <p><em>Please stay on this page (unless redirected for auth, etc.) until publishing is complete!</em></p>
    <publisher-wrapper if={ !Publishing.post.existingPrimaryUrl } pub={ Publishing.post.primaryLoc } pubtype="primary"></publisher-wrapper>
    <publisher-wrapper each={ v in Publishing.post.secondaryLocs } pub={ v } pubtype="secondary"></publisher-wrapper>
  </div>
</post-publisher>

<publisher-wrapper>
  <div class="mui-panel">
    <h4>{ opts.pub.publisherName }</h4>
    <h5 if={ opts.pubtype == "primary" }>PRIMARY</h5>
    <pm-progressbar value={ progressValue } barcolor={ barcolor }></pm-progressbar>
    <p>{ statusMessage }</p>
  </div>
  <script>
    console.log("Made it to publisher-wrapper!");
    var self = this;
    self.progressValue = 33;
    self.barcolor = App.COLORS.PRIMARY;
    self.statusMessage = "Status message.";
    self.update();
    var conf = Publishing.getCurrentPubConf();
    console.log("conf: " + conf);
    if (opts.pub && conf.publisherId == opts.pub.publisherId) {
      var dat = Publishing.getDat(conf.publisherId);
      var jso = null;
      if (Publishing.cbjso) {
        jso = Publishing.cbjso;
      } else {
        dat.jsoConfig = {
          providerID: "google",
          client_id: "853943586263-f2ondnhfv7nbnk6m0ia64qr807of7i0k.apps.googleusercontent.com",
          redirect_uri: "https://postmaker.surge.sh",
          authorization: "https://accounts.google.com/o/oauth2/auth",
          scopes: { request: ["https://www.googleapis.com/auth/gmail.send"] }
        }
        jso = new JSO(dat.jsoConfig);
        Publishing.waitingOnOauth = true;
        Publishing.commit();
        jso.getToken();
      }
      jso.getToken(function(token) {
          console.log("TOKEN!!!!! " + token);
          self.statusMessage = "Token: " + token;
          self.update();
      });
    }
  </script>
  <style scoped>
    .mui-panel h4, h5 {
      margin-top: 0px;
      display: inline-block;
    }
    .mui-panel h5 {
      float: right;
    }
    .mui-panel p {
      margin-top: 10px;
      margin-bottom: 0px;
    }
  </style>
</publisher-wrapper>
